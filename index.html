<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Connexion Vixel</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background-color: #111; color: #fff; text-align: center; padding: 50px; }
    input, button { padding: 10px; margin: 10px; font-size: 16px; }
    #error-message { color: #ff4f4f; margin-top: 10px; }
  </style>
</head>
<body>

  <h1>Connexion Vixel</h1>

  <input type="text" id="pseudo" placeholder="Pseudo"><br>
  <input type="email" id="email" placeholder="Email"><br>
  <input type="password" id="password" placeholder="Mot de passe"><br>
  <button onclick="login()">Connexion</button>
  <div id="error-message"></div>

  <script>
    // Configuration Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDQGmbiwh5LTVq0Wp1q9NrSQzs86vER2XM",
  authDomain: "kychat-45596.firebaseapp.com",
  databaseURL: "https://kychat-45596-default-rtdb.firebaseio.com",
  projectId: "kychat-45596",
  storageBucket: "kychat-45596.firebasestorage.app",
  messagingSenderId: "104462848972",
  appId: "1:104462848972:web:7ac49e63008e9a11150369"
};
    firebase.initializeApp(firebaseConfig);

    function login() {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      const pseudo = document.getElementById("pseudo").value.trim();
      const errorDiv = document.getElementById("error-message");
      errorDiv.textContent = "";

      if (!email || !password) {
        alert("Veuillez remplir l’email et le mot de passe.");
        return;
      }

      // Obtenir l'adresse IP de l'utilisateur
      fetch("https://api.ipify.org?format=json")
        .then(res => res.json())
        .then(data => {
          const userIP = data.ip;
          const accountsRef = firebase.database().ref("accounts");

          // Créer les listes si elles n'existent pas
          accountsRef.child("banned-emails").once("value").then(snap => {
            if (!snap.exists()) accountsRef.child("banned-emails").set({});
          });

          accountsRef.child("banned-ips").once("value").then(snap => {
            if (!snap.exists()) accountsRef.child("banned-ips").set({});
          });

          // Vérifier si l’email est banni
          accountsRef.child("banned-emails").once("value").then(emailSnap => {
            const bannedEmails = emailSnap.val() || {};
            const isEmailBanned = Object.values(bannedEmails).includes(email);

            if (isEmailBanned) {
              errorDiv.textContent = "Erreur de connexion : Cette adresse email est bannie de Vixel.";
              return;
            }

            // Vérifier si l’IP est bannie
            accountsRef.child("banned-ips").once("value").then(ipSnap => {
              const bannedIPs = ipSnap.val() || {};
              const isIPBanned = Object.values(bannedIPs).includes(userIP);

              if (isIPBanned) {
                errorDiv.textContent = "Erreur de connexion : Cette adresse IP est bannie de Vixel.";
                return;
              }

              // Si non banni, tenter la connexion
              firebase.auth().signInWithEmailAndPassword(email, password)
                .then(userCredential => {
                  const uid = userCredential.user.uid;
                  checkDiscordLink(uid);
                })
                .catch(() => {
                  // Créer un nouveau compte si la connexion échoue
                  firebase.auth().createUserWithEmailAndPassword(email, password)
                    .then(userCredential => {
                      const uid = userCredential.user.uid;
                      const accountData = {
                        email: email,
                        pseudo: pseudo || "Inconnu",
                        createdAt: Date.now(),
                        ip: userIP
                      };

                      firebase.database().ref("accounts/" + uid).set(accountData)
                        .then(() => {
                          window.location.href = "link.html";
                        });
                    })
                    .catch(err => {
                      errorDiv.textContent = "Erreur : " + err.message;
                    });
                });
            });
          });
        })
        .catch(err => {
          console.error("Erreur IP :", err);
          errorDiv.textContent = "Erreur lors de la récupération de l’adresse IP.";
        });
    }

    function checkDiscordLink(uid) {
      firebase.database().ref("accounts/" + uid + "/link").once("value")
        .then(snapshot => {
          if (snapshot.exists()) {
            window.location.href = "main.html";
          } else {
            window.location.href = "link.html";
          }
        })
        .catch(err => {
          console.error("Erreur Discord link :", err);
          document.getElementById("error-message").textContent = "Erreur de connexion.";
        });
    }
  </script>

</body>
</html>
