<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Main - VIX & Pr√©sence</title>
<style>
    body {
      margin: 0;
      font-family: 'Press Start 2P', cursive;
      background: #f0f0f0;
      cursor: url('cursor.png'), auto;
    }
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #222;
      padding: 10px 20px;
      color: white;
      user-select: none;
      font-family: 'Press Start 2P', cursive; /* Ajout√© explicitement */
    }
    .presence {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      font-family: 'Press Start 2P', cursive; /* forcer ici aussi */
    }
    .presence img {
      width: 24px;
      height: 24px;
    }
    .shop-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 12px;
      user-select: none;
      color: white;
      font-family: 'Press Start 2P', cursive; /* forcer ici aussi */
    }
    .shop-btn img {
      width: 24px;
      height: 24px;
    }
    .vix-container {
      background: #888888cc;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 6px;
      font-weight: bold;
      font-size: 12px;
      font-family: 'Press Start 2P', cursive; /* forcer ici aussi */
    }
    .vix-container img {
      width: 24px;
      height: 24px;
    }
  .pixel-container {
  background: #888888cc;
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  border-radius: 6px;
  font-weight: bold;
  font-size: 12px;
  font-family: 'Press Start 2P', cursive;
  margin-left: 10px;
}
.pixel-container img {
  width: 24px;
  height: 24px;
}

.popup-overlay {
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background: rgba(0, 0, 0, 0.7);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 999;
}

.popup {
  background: #fff;
  border-radius: 12px;
  padding: 20px;
  max-width: 500px;
  width: 90%;
  font-family: 'Press Start 2P', cursive;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.offer {
  background: #eeeeee;
  border-radius: 12px;
  padding: 12px;
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
}

.offer img {
  width: 80px;
  height: auto;
}

.offer button {
  margin-top: 10px;
  font-family: 'Press Start 2P', cursive;
  background: #222;
  color: white;
  padding: 6px 12px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}
/* Curseur custom */



/* Hotbar de couleur */
.color-hotbar {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(20, 20, 20, 0.7);
  padding: 10px 15px;
  border-radius: 15px;
  display: flex;
  gap: 12px;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.4);
  z-index: 1000;
  border: 2px solid rgba(255, 255, 255, 0.2);
  backdrop-filter: blur(5px);
}

/* Chaque couleur dans la hotbar */
.color-slot {
  width: 40px;
  height: 40px;
  border-radius: 8px;
  border: 2px solid white;
  box-shadow: inset 0 0 4px rgba(0, 0, 0, 0.4);
  cursor: pointer;
  transition: transform 0.2s ease, border 0.2s ease;
}

.color-slot.selected {
  transform: scale(1.2);
  border: 3px solid gold;
  box-shadow: 0 0 10px gold;
}

/* Couleurs */
.color-slot.red { background-color: red; }
.color-slot.yellow { background-color: yellow; }
.color-slot.blue { background-color: blue; }
.color-slot.green { background-color: green; }
.color-slot.purple { background-color: purple; }


  </style>
</head>
<body>
   <div class="topbar">
    <div class="presence">
      <img src="online.png" alt="Online" />
      <span id="onlineCount">0</span>
    </div>

    <div class="shop-btn" onclick="openShop()">
      <img src="shop.png" alt="Boutique" />
      <span>Boutique</span>
    </div>
<div class="pixel-container">
  <img src="pixel.png" alt="Pixels" />
  <span id="pixelCount">0 Pixels</span>
</div>

  
    <div class="vix-container">
      <img src="vix.png" alt="VIX" />
      <span id="vixCount">0 VIX</span>
    </div>
  </div>
<div class="popup-overlay" id="shopPopup">
  <div class="popup" id="offersContainer">
    <!-- Offres inject√©es ici -->
    <button onclick="closeShop()" style="margin-top: 20px;">Fermer</button>
  </div>
</div>
<div class="color-hotbar">
  <div class="color-slot red" data-color="red"></div>
  <div class="color-slot yellow" data-color="yellow"></div>
  <div class="color-slot blue" data-color="blue"></div>
  <div class="color-slot green" data-color="green"></div>
  <div class="color-slot purple" data-color="purple"></div>
</div>
<canvas id="pixelCanvas"></canvas>




  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
  const firebaseConfig = {
    apiKey: "AIzaSyDQGmbiwh5LTVq0Wp1q9NrSQzs86vER2XM",
    authDomain: "kychat-45596.firebaseapp.com",
    databaseURL: "https://kychat-45596-default-rtdb.firebaseio.com",
    projectId: "kychat-45596",
    storageBucket: "kychat-45596.appspot.com",
    messagingSenderId: "104462848972",
    appId: "1:104462848972:web:7ac49e63008e9a11150369"
  };

  firebase.initializeApp(firebaseConfig);

  const onlineCountSpan = document.getElementById("onlineCount");
  const vixCountSpan = document.getElementById("vixCount");
  const pixelCountSpan = document.getElementById("pixelCount");
  const shopPopup = document.getElementById("shopPopup");
let scale = 1;           // facteur de zoom
let offsetX = 0;         // d√©calage X (pan)
let offsetY = 0;         // d√©calage Y (pan)


  let uid, discordId, presenceRef;

  firebase.auth().onAuthStateChanged(async user => {
    if (!user) {
      window.location.href = "index.html";
      return;
    }

    uid = user.uid;

    try {
      const linkSnap = await firebase.database().ref("accounts/" + uid + "/link").once("value");
      discordId = linkSnap.val();

      if (!discordId) {
        alert("Aucun compte Discord li√©, merci de le faire sur link.html");
        window.location.href = "link.html";
        return;
      }

      setupPresence();
      listenOnlineCount();
      listenVix();
      listenPixels();
      listenVisiblePixels();

    } catch (err) {
      console.error(err);
      alert("Erreur lors de la r√©cup√©ration des donn√©es.");
    }
  });

  function setupPresence() {
    presenceRef = firebase.database().ref("presence/" + uid);
    presenceRef.set(true);
    window.addEventListener("beforeunload", () => {
      presenceRef.set(false);
    });
    presenceRef.onDisconnect().set(false);
  }

  function listenOnlineCount() {
    firebase.database().ref("presence").on("value", snapshot => {
      const presenceData = snapshot.val() || {};
      let count = 0;
      for (const key in presenceData) {
        if (presenceData[key] === true) count++;
      }
      onlineCountSpan.textContent = count;
    });
  }

  function listenVix() {
    firebase.database().ref("users/" + discordId + "/balance").on("value", snapshot => {
      const vix = snapshot.val();
      vixCountSpan.textContent = (vix !== null ? vix : 0) + " VIX";
    });
  }

  function listenPixels() {
    firebase.database().ref("accounts/" + uid + "/pixels").on("value", snapshot => {
      const pixels = snapshot.val();
      pixelCountSpan.textContent = (pixels !== null ? pixels : 0) + " Pixels";
    });
  }

  function openShop() {
    shopPopup.style.display = "flex";
    loadOffers();
  }

  function closeShop() {
    shopPopup.style.display = "none";
  }

  function loadOffers() {
    const offersContainer = document.getElementById("offersContainer");
    offersContainer.innerHTML = ""; // On vide les anciennes offres

    const closeBtn = document.createElement("button");
    closeBtn.textContent = "Fermer";
    closeBtn.style.marginTop = "20px";
    closeBtn.onclick = closeShop;

    firebase.database().ref("offers").once("value").then(snapshot => {
      const offers = snapshot.val();

      if (!offers) {
        const noOffer = document.createElement("div");
        noOffer.textContent = "Aucune offre disponible.";
        noOffer.style.textAlign = "center";
        offersContainer.appendChild(noOffer);
        offersContainer.appendChild(closeBtn);
        return;
      }

      for (const offerId in offers) {
        const offer = offers[offerId];

        const offerDiv = document.createElement("div");
        offerDiv.className = "offer";

        const title = document.createElement("div");
        title.textContent = `${offer.pixels} PIXELS`;

        const cost = document.createElement("div");
        cost.textContent = `Co√ªt : ${offer.cost} VIX`;

        const img = document.createElement("img");
        img.src = offer.image;
        img.alt = `${offer.pixels} Pixels`;

        const buyBtn = document.createElement("button");
        buyBtn.textContent = "Acheter";
        buyBtn.onclick = () => buyPixels(offer.pixels, offer.cost);

        offerDiv.appendChild(title);
        offerDiv.appendChild(cost);
        offerDiv.appendChild(img);
        offerDiv.appendChild(buyBtn);

        offersContainer.appendChild(offerDiv);
      }

      offersContainer.appendChild(closeBtn);
    });
  }

  function buyPixels(pixelsToAdd, vixCost) {
    const userRef = firebase.database().ref("users/" + discordId + "/balance");
    const pixelRef = firebase.database().ref("accounts/" + uid + "/pixels");

    userRef.once("value").then(vixSnap => {
      const currentVix = vixSnap.val() || 0;

      if (currentVix < vixCost) {
        alert("Pas assez de VIX !");
        return;
      }

      userRef.set(currentVix - vixCost);

      pixelRef.once("value").then(pixelSnap => {
        const currentPixels = pixelSnap.val() || 0;
        pixelRef.set(currentPixels + pixelsToAdd);
      });

      alert("Achat r√©ussi !");
    });
  }
let selectedColor = null;

document.querySelectorAll('.color-slot').forEach(slot => {
  slot.addEventListener('click', () => {
    // Enlever la s√©lection pr√©c√©dente
    document.querySelectorAll('.color-slot').forEach(s => s.classList.remove('selected'));

    // Ajouter la nouvelle s√©lection
    slot.classList.add('selected');
    selectedColor = slot.dataset.color;

    console.log("üé® Couleur s√©lectionn√©e :", selectedColor);
  });
});
const canvas = document.getElementById("pixelCanvas");
const ctx = canvas.getContext("2d");

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// Taille d'un pixel
const PIXEL_SIZE = 10;

// Zone charg√©e autour du joueur (en pixels)


// Adapter le canvas en cas de redimensionnement
window.addEventListener("resize", () => {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
});

// Suivi des pixels d√©j√† dessin√©s
const drawnPixels = {};

function drawPixel(x, y, color) {
  ctx.fillStyle = color;
  // Ici on applique l‚Äô√©chelle et les offsets
  ctx.fillRect(
    (x * PIXEL_SIZE - offsetX) * scale, 
    (y * PIXEL_SIZE - offsetY) * scale, 
    PIXEL_SIZE * scale, 
    PIXEL_SIZE * scale
  );
}

function listenVisiblePixels() {
  const pixelsRef = firebase.database().ref("pixels");
  pixelsRef.on("child_added", (snapshot) => {
    const key = snapshot.key; // format "x_y"
    const data = snapshot.val();

    const [x, y] = key.split("_").map(Number);
    drawnPixels[key] = data;

    if (isPixelVisible(x, y)) {
      drawPixel(x, y, data.color);
    }
  });

  pixelsRef.on("child_changed", (snapshot) => {
    const key = snapshot.key;
    const data = snapshot.val();
    const [x, y] = key.split("_").map(Number);
    drawnPixels[key] = data;

    if (isPixelVisible(x, y)) {
      drawPixel(x, y, data.color);
    }
  });
}
function redrawAllPixels() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  for (const key in drawnPixels) {
    const [x, y] = key.split("_").map(Number);
    if (isPixelVisible(x, y)) {
      drawPixel(x, y, drawnPixels[key].color);
    }
  }
}

function isPixelVisible(x, y) {
  const px = (x * PIXEL_SIZE - offsetX) * scale;
  const py = (y * PIXEL_SIZE - offsetY) * scale;
  return (
    px + PIXEL_SIZE * scale >= 0 &&
    px <= canvas.width &&
    py + PIXEL_SIZE * scale >= 0 &&
    py <= canvas.height
  );
}

canvas.addEventListener("click", function(event) {
    const rect = canvas.getBoundingClientRect();
    const mouseX = event.clientX - rect.left;
    const mouseY = event.clientY - rect.top;

    // Corriger la position en fonction du zoom et des offsets
    const x = Math.floor((mouseX - offsetX) / scale);
    const y = Math.floor((mouseY - offsetY) / scale);

    if (balance >= 10) {
        const pixelRef = firebase.database().ref("pixels/" + x + "_" + y);
        pixelRef.set({ x, y, color: selectedColor });
        balance -= 10;
        updateBalance();
    } else {
        alert("Pas assez de balance !");
    }
});


  // Placer le pixel
  firebase.database().ref(pixelPath).set({
    color: selectedColor,
    placedBy: uid,
    timestamp: Date.now()
  });

  // D√©cr√©menter le compte de pixels
  pixelRef.set(pixelCount - 1);
});

canvas.addEventListener("wheel", (e) => {
  e.preventDefault();

  const zoomIntensity = 0.1;
  const mouseX = e.clientX;
  const mouseY = e.clientY;

  // Calcul du zoom autour de la souris
  const wheel = e.deltaY < 0 ? 1 : -1;

  const newScale = scale * (1 + wheel * zoomIntensity);
  if (newScale < 0.5 || newScale > 5) return; // limites du zoom

  // Pour zoomer sur le point de la souris, ajuster les offsets
  offsetX = (offsetX + mouseX / scale) - (mouseX / newScale);
  offsetY = (offsetY + mouseY / scale) - (mouseY / newScale);

  scale = newScale;

  // Redessiner la carte
  redrawAllPixels();
});
let isDragging = false;
let dragStartX, dragStartY;

canvas.addEventListener("mousedown", e => {
  isDragging = true;
  dragStartX = e.clientX;
  dragStartY = e.clientY;
});

canvas.addEventListener("mousemove", e => {
  if (isDragging) {
    const dx = (e.clientX - dragStartX) / scale;
    const dy = (e.clientY - dragStartY) / scale;
    offsetX -= dx;
    offsetY -= dy;
    dragStartX = e.clientX;
    dragStartY = e.clientY;
    redrawAllPixels();
  }
});

canvas.addEventListener("mouseup", () => {
  isDragging = false;
});
canvas.addEventListener("mouseleave", () => {
  isDragging = false;
});



  </script>
</body>
</html>
