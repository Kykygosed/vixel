<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Main - VIX & Présence</title>
<style>
    body {
      margin: 0;
      font-family: 'Press Start 2P', cursive;
      background: #f0f0f0;
    }
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #222;
      padding: 10px 20px;
      color: white;
      user-select: none;
      font-family: 'Press Start 2P', cursive; /* Ajouté explicitement */
    }
    .presence {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      font-family: 'Press Start 2P', cursive; /* forcer ici aussi */
    }
    .presence img {
      width: 24px;
      height: 24px;
    }
    .shop-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 12px;
      user-select: none;
      color: white;
      font-family: 'Press Start 2P', cursive; /* forcer ici aussi */
    }
    .shop-btn img {
      width: 24px;
      height: 24px;
    }
    .vix-container {
      background: #888888cc;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 6px;
      font-weight: bold;
      font-size: 12px;
      font-family: 'Press Start 2P', cursive; /* forcer ici aussi */
    }
    .vix-container img {
      width: 24px;
      height: 24px;
    }
  .pixel-container {
  background: #888888cc;
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  border-radius: 6px;
  font-weight: bold;
  font-size: 12px;
  font-family: 'Press Start 2P', cursive;
  margin-left: 10px;
}
.pixel-container img {
  width: 24px;
  height: 24px;
}

.popup-overlay {
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background: rgba(0, 0, 0, 0.7);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 999;
}

.popup {
  background: #fff;
  border-radius: 12px;
  padding: 20px;
  max-width: 500px;
  width: 90%;
  font-family: 'Press Start 2P', cursive;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.offer {
  background: #eeeeee;
  border-radius: 12px;
  padding: 12px;
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
}

.offer img {
  width: 80px;
  height: auto;
}

.offer button {
  margin-top: 10px;
  font-family: 'Press Start 2P', cursive;
  background: #222;
  color: white;
  padding: 6px 12px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

  </style>
</head>
<body>
   <div class="topbar">
    <div class="presence">
      <img src="online.png" alt="Online" />
      <span id="onlineCount">0</span>
    </div>

    <div class="shop-btn" onclick="openShop()">
      <img src="shop.png" alt="Boutique" />
      <span>Boutique</span>
    </div>
<div class="pixel-container">
  <img src="pixel.png" alt="Pixels" />
  <span id="pixelCount">0 Pixels</span>
</div>

  
    <div class="vix-container">
      <img src="vix.png" alt="VIX" />
      <span id="vixCount">0 VIX</span>
    </div>
  </div>
<div class="popup-overlay" id="shopPopup">
  <div class="popup" id="offersContainer">
    <!-- Offres injectées ici -->
    <button onclick="closeShop()" style="margin-top: 20px;">Fermer</button>
  </div>
</div>



  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
  const firebaseConfig = {
    apiKey: "AIzaSyDQGmbiwh5LTVq0Wp1q9NrSQzs86vER2XM",
    authDomain: "kychat-45596.firebaseapp.com",
    databaseURL: "https://kychat-45596-default-rtdb.firebaseio.com",
    projectId: "kychat-45596",
    storageBucket: "kychat-45596.appspot.com",
    messagingSenderId: "104462848972",
    appId: "1:104462848972:web:7ac49e63008e9a11150369"
  };

  firebase.initializeApp(firebaseConfig);

  const onlineCountSpan = document.getElementById("onlineCount");
  const vixCountSpan = document.getElementById("vixCount");
  const pixelCountSpan = document.getElementById("pixelCount");
  const shopPopup = document.getElementById("shopPopup");

  let uid, discordId, presenceRef;

  firebase.auth().onAuthStateChanged(async user => {
    if (!user) {
      window.location.href = "index.html";
      return;
    }

    uid = user.uid;

    try {
      const linkSnap = await firebase.database().ref("accounts/" + uid + "/link").once("value");
      discordId = linkSnap.val();

      if (!discordId) {
        alert("Aucun compte Discord lié, merci de le faire sur link.html");
        window.location.href = "link.html";
        return;
      }

      setupPresence();
      listenOnlineCount();
      listenVix();
      listenPixels();

    } catch (err) {
      console.error(err);
      alert("Erreur lors de la récupération des données.");
    }
  });

  function setupPresence() {
    presenceRef = firebase.database().ref("presence/" + uid);
    presenceRef.set(true);
    window.addEventListener("beforeunload", () => {
      presenceRef.set(false);
    });
    presenceRef.onDisconnect().set(false);
  }

  function listenOnlineCount() {
    firebase.database().ref("presence").on("value", snapshot => {
      const presenceData = snapshot.val() || {};
      let count = 0;
      for (const key in presenceData) {
        if (presenceData[key] === true) count++;
      }
      onlineCountSpan.textContent = count;
    });
  }

  function listenVix() {
    firebase.database().ref("users/" + discordId + "/balance").on("value", snapshot => {
      const vix = snapshot.val();
      vixCountSpan.textContent = (vix !== null ? vix : 0) + " VIX";
    });
  }

  function listenPixels() {
    firebase.database().ref("accounts/" + uid + "/pixels").on("value", snapshot => {
      const pixels = snapshot.val();
      pixelCountSpan.textContent = (pixels !== null ? pixels : 0) + " Pixels";
    });
  }

  function openShop() {
    shopPopup.style.display = "flex";
    loadOffers();
  }

  function closeShop() {
    shopPopup.style.display = "none";
  }

  function loadOffers() {
    const offersContainer = document.getElementById("offersContainer");
    offersContainer.innerHTML = ""; // On vide les anciennes offres

    const closeBtn = document.createElement("button");
    closeBtn.textContent = "Fermer";
    closeBtn.style.marginTop = "20px";
    closeBtn.onclick = closeShop;

    firebase.database().ref("offers").once("value").then(snapshot => {
      const offers = snapshot.val();

      if (!offers) {
        const noOffer = document.createElement("div");
        noOffer.textContent = "Aucune offre disponible.";
        noOffer.style.textAlign = "center";
        offersContainer.appendChild(noOffer);
        offersContainer.appendChild(closeBtn);
        return;
      }

      for (const offerId in offers) {
        const offer = offers[offerId];

        const offerDiv = document.createElement("div");
        offerDiv.className = "offer";

        const title = document.createElement("div");
        title.textContent = `${offer.pixels} PIXELS`;

        const cost = document.createElement("div");
        cost.textContent = `Coût : ${offer.cost} VIX`;

        const img = document.createElement("img");
        img.src = offer.image;
        img.alt = `${offer.pixels} Pixels`;

        const buyBtn = document.createElement("button");
        buyBtn.textContent = "Acheter";
        buyBtn.onclick = () => buyPixels(offer.pixels, offer.cost);

        offerDiv.appendChild(title);
        offerDiv.appendChild(cost);
        offerDiv.appendChild(img);
        offerDiv.appendChild(buyBtn);

        offersContainer.appendChild(offerDiv);
      }

      offersContainer.appendChild(closeBtn);
    });
  }

  function buyPixels(pixelsToAdd, vixCost) {
    const userRef = firebase.database().ref("users/" + discordId + "/balance");
    const pixelRef = firebase.database().ref("accounts/" + uid + "/pixels");

    userRef.once("value").then(vixSnap => {
      const currentVix = vixSnap.val() || 0;

      if (currentVix < vixCost) {
        alert("Pas assez de VIX !");
        return;
      }

      userRef.set(currentVix - vixCost);

      pixelRef.once("value").then(pixelSnap => {
        const currentPixels = pixelSnap.val() || 0;
        pixelRef.set(currentPixels + pixelsToAdd);
      });

      alert("Achat réussi !");
    });
  }



  </script>
</body>
</html>
